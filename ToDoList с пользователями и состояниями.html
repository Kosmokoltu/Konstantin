using System;
using System.Collections.Generic;
using System.Linq;

// Пользовательские исключения
public class TaskCountLimitException : Exception
{
    public TaskCountLimitException(int taskCountLimit)
        : base($"Превышено максимальное количество задач равное {taskCountLimit}") { }
}

public class TaskLengthLimitException : Exception
{
    public TaskLengthLimitException(int taskLength, int taskLengthLimit)
        : base($"Длина задачи '{taskLength}' превышает максимально допустимое значение {taskLengthLimit}") { }
}

public class DuplicateTaskException : Exception
{
    public DuplicateTaskException(string task)
        : base($"Задача '{task}' уже существует") { }
}

// Модели
public enum ToDoItemState
{
    Active,
    Completed
}

public class ToDoUser
{
    public Guid UserId { get; }
    public string TelegramUserName { get; }
    public DateTime RegisteredAt { get; }

    public ToDoUser(string telegramUserName)
    {
        if (string.IsNullOrWhiteSpace(telegramUserName))
            throw new ArgumentException("Имя пользователя не должно быть пустым.");

        UserId = Guid.NewGuid();
        TelegramUserName = telegramUserName;
        RegisteredAt = DateTime.UtcNow;
    }
}

public class ToDoItem
{
    public Guid Id { get; }
    public ToDoUser User { get; }
    public string Name { get; }
    public DateTime CreatedAt { get; }
    public ToDoItemState State { get; private set; }
    public DateTime? StateChangedAt { get; private set; }

    public ToDoItem(ToDoUser user, string name)
    {
        if (user == null)
            throw new ArgumentNullException(nameof(user));

        if (string.IsNullOrWhiteSpace(name))
            throw new ArgumentException("Имя задачи не должно быть пустым.");

        Id = Guid.NewGuid();
        User = user;
        Name = name;
        CreatedAt = DateTime.UtcNow;
        State = ToDoItemState.Active;
        StateChangedAt = null;
    }

    public void Complete()
    {
        if (State == ToDoItemState.Completed)
            return;

        State = ToDoItemState.Completed;
        StateChangedAt = DateTime.UtcNow;
    }
}

class Program
{
    static void Main(string[] args)
    {
        try
        {
            Console.Write("Введите максимально допустимое количество задач (1-100): ");
            int taskLimit = ParseAndValidateInt(Console.ReadLine(), 1, 100);

            Console.Write("Введите максимально допустимую длину задачи (1-100): ");
            int taskLengthLimit = ParseAndValidateInt(Console.ReadLine(), 1, 100);

            Run(taskLimit, taskLengthLimit);
        }
        catch (TaskCountLimitException ex)
        {
            Console.WriteLine(ex.Message);
        }
        catch (TaskLengthLimitException ex)
        {
            Console.WriteLine(ex.Message);
        }
        catch (DuplicateTaskException ex)
        {
            Console.WriteLine(ex.Message);
        }
        catch (ArgumentException ex)
        {
            Console.WriteLine(ex.Message);
        }
        catch (Exception ex)
        {
            Console.WriteLine("Произошла непредвиденная ошибка:");
            Console.WriteLine($"Type: {ex.GetType().FullName}");
            Console.WriteLine($"Message: {ex.Message}");
            Console.WriteLine($"StackTrace: {ex.StackTrace}");
            Console.WriteLine($"InnerException: {ex.InnerException}");
        }
    }

    // Основной цикл приложения
    static void Run(int taskLimit, int taskLengthLimit)
    {
        ToDoUser? user = null;
        bool isRunning = true;
        string version = "1.0";
        string creationDate = "19.11.2025";
        List<ToDoItem> tasks = new List<ToDoItem>();

        Console.WriteLine("Добро пожаловать в меню хоккейного одевалкина!");
        Console.WriteLine("Доступные команды: /start, /help, /info, /echo, /addtask, /showtasks, /showalltasks, /removetask, /completetask, /exit");

        while (isRunning)
        {
            Console.Write("> ");
            var input = Console.ReadLine();

            if (input == null)
            {
                Console.WriteLine("Пустой ввод. Введите /help для списка команд.");
                continue;
            }

            if (input.StartsWith("/start"))
            {
                HandleStart(ref user);
            }
            else if (input.StartsWith("/help"))
            {
                HandleHelp();
            }
            else if (input.StartsWith("/info"))
            {
                HandleInfo(version, creationDate);
            }
            else if (input.StartsWith("/echo"))
            {
                HandleEcho(input, user);
            }
            else if (input.StartsWith("/addtask"))
            {
                try
                {
                    HandleAddTask(tasks, taskLimit, taskLengthLimit, user);
                }
                catch (TaskCountLimitException ex)
                {
                    Console.WriteLine(ex.Message);
                }
                catch (TaskLengthLimitException ex)
                {
                    Console.WriteLine(ex.Message);
                }
                catch (DuplicateTaskException ex)
                {
                    Console.WriteLine(ex.Message);
                }
                catch (ArgumentException ex)
                {
                    Console.WriteLine(ex.Message);
                }
            }
            else if (input.StartsWith("/showtasks"))
            {
                HandleShowTasks(tasks);
            }
            else if (input.StartsWith("/showalltasks"))
            {
                HandleShowAllTasks(tasks);
            }
            else if (input.StartsWith("/removetask"))
            {
                try
                {
                    HandleRemoveTask(tasks);
                }
                catch (ArgumentException ex)
                {
                    Console.WriteLine(ex.Message);
                }
            }
            else if (input.StartsWith("/completetask"))
            {
                HandleCompleteTask(input, tasks);
            }
            else if (input.StartsWith("/exit"))
            {
                Console.WriteLine("Программа завершена.");
                isRunning = false;
            }
            else
            {
                Console.WriteLine("Неизвестная команда. Введите /help для списка команд.");
            }
        }
    }

    // Методы валидации
    static int ParseAndValidateInt(string? str, int min, int max)
    {
        if (!int.TryParse(str, out int value))
            throw new ArgumentException("Ожидается целое число.");

        if (value < min || value > max)
            throw new ArgumentException($"Число должно быть в диапазоне от {min} до {max}.");

        return value;
    }

    static void ValidateString(string? str)
    {
        if (string.IsNullOrWhiteSpace(str))
            throw new ArgumentException("Строка не должна быть пустой и состоять только из пробелов.");
    }

    // Обработчики команд
    static void HandleStart(ref ToDoUser? user)
    {
        Console.Write("Пожалуйста, введите своё имя: ");
        string? name = Console.ReadLine();
        ValidateString(name);
        user = new ToDoUser(name!);
        Console.WriteLine($"Здравствуйте, {user.TelegramUserName}! Теперь доступна команда /echo.");
    }

    static void HandleHelp()
    {
        Console.WriteLine("Справка:");
        Console.WriteLine("/start - начать работу и ввести имя");
        Console.WriteLine("/help - показать это сообщение");
        Console.WriteLine("/info - информация о программе");
        Console.WriteLine("/echo <текст> - повторить введённый текст (доступно после /start)");
        Console.WriteLine("/addtask - добавить новую задачу в список");
        Console.WriteLine("/showtasks - показать все активные задачи");
        Console.WriteLine("/showalltasks - показать все задачи с любым статусом");
        Console.WriteLine("/removetask - удалить задачу по номеру");
        Console.WriteLine("/completetask <Id> - отметить задачу как выполненную по Id");
        Console.WriteLine("/exit - выйти из программы");
    }

    static void HandleInfo(string version, string creationDate)
    {
        Console.WriteLine($"Версия программы: {version}");
        Console.WriteLine($"Дата создания: {creationDate}");
    }

    static void HandleEcho(string input, ToDoUser? user)
    {
        if (user != null)
        {
            string message = input.Length > 6 ? input.Substring(6) : "";
            Console.WriteLine($"{user.TelegramUserName}, ваш текст: {message}");
        }
        else
        {
            Console.WriteLine("Сначала введите команду /start и имя.");
        }
    }

    static void HandleAddTask(List<ToDoItem> tasks, int taskLimit, int taskLengthLimit, ToDoUser? user)
    {
        if (user == null)
        {
            Console.WriteLine("Сначала введите команду /start и имя.");
            return;
        }

        Console.Write("Введите описание задачи: ");
        string? taskName = Console.ReadLine();

        ValidateString(taskName);

        if (tasks.Count >= taskLimit)
            throw new TaskCountLimitException(taskLimit);

        if (taskName!.Length > taskLengthLimit)
            throw new TaskLengthLimitException(taskName.Length, taskLengthLimit);

        if (tasks.Exists(t => t.Name == taskName && t.User.UserId == user.UserId))
            throw new DuplicateTaskException(taskName);

        var item = new ToDoItem(user, taskName);
        tasks.Add(item);
        Console.WriteLine($"Задача добавлена. Id: {item.Id}");
    }

    static void HandleShowTasks(List<ToDoItem> tasks)
    {
        var activeTasks = tasks.Where(t => t.State == ToDoItemState.Active).ToList();

        if (activeTasks.Count == 0)
        {
            Console.WriteLine("Список активных задач пуст.");
        }
        else
        {
            Console.WriteLine("Список активных задач:");
            for (int i = 0; i < activeTasks.Count; i++)
            {
                var t = activeTasks[i];
                Console.WriteLine($"{i + 1}. {t.Name} - {t.CreatedAt:dd.MM.yyyy HH:mm:ss} - {t.Id}");
            }
        }
    }

    static void HandleShowAllTasks(List<ToDoItem> tasks)
    {
        if (tasks.Count == 0)
        {
            Console.WriteLine("Список задач пуст.");
        }
        else
        {
            Console.WriteLine("Все задачи:");
            for (int i = 0; i < tasks.Count; i++)
            {
                var t = tasks[i];
                Console.WriteLine($"{i + 1}. ({t.State}) {t.Name} - {t.CreatedAt:dd.MM.yyyy HH:mm:ss} - {t.Id}");
            }
        }
    }

    static void HandleRemoveTask(List<ToDoItem> tasks)
    {
        if (tasks.Count == 0)
        {
            Console.WriteLine("Список задач пуст, удалять нечего.");
            return;
        }

        Console.WriteLine("Текущие задачи:");
        for (int i = 0; i < tasks.Count; i++)
        {
            var t = tasks[i];
            Console.WriteLine($"{i + 1}. ({t.State}) {t.Name} - {t.CreatedAt:dd.MM.yyyy HH:mm:ss} - {t.Id}");
        }

        Console.Write("Введите номер задачи для удаления: ");
        string? indexInput = Console.ReadLine();
        int index = ParseAndValidateInt(indexInput, 1, tasks.Count);

        tasks.RemoveAt(index - 1);
        Console.WriteLine("Задача удалена.");
    }

    static void HandleCompleteTask(string input, List<ToDoItem> tasks)
    {
        var parts = input.Split(' ', StringSplitOptions.RemoveEmptyEntries);

        if (parts.Length < 2)
        {
            Console.WriteLine("Нужно передать Id задачи. Пример: /completetask 73c7940a-ca8c-4327-8a15-9119bffd1d5e");
            return;
        }

        if (!Guid.TryParse(parts[1], out Guid id))
        {
            Console.WriteLine("Некорректный формат Id.");
            return;
        }

        var task = tasks.FirstOrDefault(t => t.Id == id);
        if (task == null)
        {
            Console.WriteLine("Задача с таким Id не найдена.");
            return;
        }

        task.Complete();
        Console.WriteLine("Задача отмечена как выполненная.");
    }
}
